# Build System Documentation

## Table of Contents

- [Build System Documentation](#build-system-documentation)
	- [Table of Contents](#table-of-contents)
	- [Fixed Build System (v3.6.0+)](#fixed-build-system-v360)
		- [Key Improvements](#key-improvements)
		- [Available Commands](#available-commands)
		- [Build Output](#build-output)
		- [Workflow](#workflow)
			- [For Development](#for-development)
			- [For Release](#for-release)
			- [For Platform-Specific Release](#for-platform-specific-release)
		- [How It Works](#how-it-works)
		- [Troubleshooting](#troubleshooting)
		- [Architecture](#architecture)
		- [Notes](#notes)

## Fixed Build System (v3.6.0+)

The build system has been fixed to prevent infinite rebuild loops while properly handling versioning and packaging.

### Key Improvements

1. **Infinite Loop Prevention**: Watch mode now ignores generated files:
   - `manifest-firefox.json`
   - `manifest-chromium.json`
   - `handler-registry.js`
   - `dist/` directory

2. **Smart Domain Updates**: Domain generation only runs when explicitly requested or during packaging, not on every watch rebuild

3. **Version-Aware Packaging**: All packages are named with the version from `package.json`:
   - `RanobeGemini_v{VERSION}_firefox.zip`
   - `RanobeGemini_v{VERSION}_chromium.zip`

### Available Commands

```bash
# Development
npm run watch              # Watch src/ and rebuild on changes
npm run build              # Build for both Firefox and Chromium

# Platform-specific builds
npm run build:firefox      # Build for Firefox only
npm run build:chromium     # Build for Chromium only

# Packaging
npm run package            # Build and package both platforms (with versioning)
npm run package:firefox    # Build and package Firefox only
npm run package:chromium   # Build and package Chromium only
npm run package:source     # Package source code

# Utilities
npm run update-domains     # Manually update manifest domains from handlers
npm run publish            # Build, package both platforms, and source code
```

### Build Output

- **Source builds**: `dist/dist-{platform}/` directories
- **Releases**: `releases/RanobeGemini_v{VERSION}_{platform}.zip`

### Workflow

#### For Development

```bash
# Start watching for changes
npm run watch

# In another terminal, make changes to src/
# Files will automatically rebuild on save
```

#### For Release

```bash
# 1. Update version in package.json
# 2. Build and package everything
npm run publish

# This creates:
# - releases/RanobeGemini_v3.6.0_firefox.zip
# - releases/RanobeGemini_v3.6.0_chromium.zip
# - releases/source/RanobeGemini_v3.6.0_source/
```

#### For Platform-Specific Release

```bash
# Build and package only Firefox
npm run package:firefox

# Or only Chromium
npm run package:chromium
```

### How It Works

1. **watch.js**: Monitors `src/` for changes, debounces rapid changes, ignores generated files
2. **build.js**:
   - Generates handler registry
   - Optionally updates manifest domains
   - Copies assets to `dist/`
   - Embeds version from `package.json` into manifest
3. **package-firefox.js** / **package-chromium.js**: Create versioned ZIP files in `releases/`

### Troubleshooting

**Infinite rebuild loop**: ✅ Fixed in this version
- Watch mode now ignores changes to generated files

**Missing packages**:
- Run `npm install` to ensure dependencies are installed
- Check that `package.json` has a valid version

**Versioning issues**:
- Packages are automatically versioned from `package.json`
- Update the `version` field before running `npm run publish`

### Architecture

```md
dev/
├── watch.js                    # File watcher (5s cooldown to prevent loops)
├── build.js                    # Main build orchestrator
├── generate-manifest-domains.js # Domain extraction from handlers
├── package-firefox.js          # Firefox packaging script
├── package-chromium.js         # Chromium packaging script
└── package-source.js           # Source packaging script

src/
├── manifest-firefox.json       # (generated during build)
├── manifest-chromium.json      # (generated during build)
└── utils/website-handlers/
    └── handler-registry.js     # (auto-generated by build)

dist/
├── dist-firefox/               # Firefox build output
└── dist-chromium/              # Chromium build output

releases/
└── RanobeGemini_v*.*.*.zip    # Versioned packages
```

### Notes

- The `watch` command uses a 5-second cooldown after each build to prevent rapid re-triggers
- Generated files are always ignored by the watcher to prevent infinite loops
- Domain updates require the `--update` flag or happen automatically during packaging
- All output maintains semantic versioning from `package.json`
