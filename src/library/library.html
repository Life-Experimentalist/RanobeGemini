<!DOCTYPE html>
<html lang="en">

	<head>
		<meta charset="UTF-8" />
		<meta name="viewport" content="width=device-width, initial-scale=1.0" />
		<title>Novel Library - Ranobe Gemini</title>

		<!-- PWA Support -->
		<link rel="manifest" href="manifest.webmanifest" />
		<meta name="mobile-web-app-capable" content="yes" />
		<meta name="apple-mobile-web-app-capable" content="yes" />
		<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
		<meta name="apple-mobile-web-app-title" content="RG Library" />
		<meta name="theme-color" content="#e94560" />

		<link rel="stylesheet" href="library.css" />
		<link rel="stylesheet" href="edit-modal.css" />
		<link rel="icon" type="image/png" sizes="32x32" href="../icons/icon.png" />
		<link rel="apple-touch-icon" href="../icons/icon.png" />
	</head>

	<body>
		<div class="library-container">
			<!-- Header -->
			<header class="library-header">
				<div class="header-content">
					<div class="logo-section">
						<img src="../icons/icon.png" alt="Ranobe Gemini" class="logo light-mode-icon dark-mode-icon" />

						<h1>Novel Library</h1>
					</div>
					<div class="header-actions">
						<button class="btn btn-secondary" id="library-random-btn" title="Open a random novel"
							style="font-size:13px;padding:6px 10px;flex-shrink:0;">🎲 Random</button>
						<div class="search-box">
							<input type="text" id="search-input" placeholder="Search novels..." />
							<span class="search-icon">🔍</span>
						</div>
						<button class="btn btn-icon" id="refresh-btn" title="Refresh Library">
							🔄
						</button>
						<button class="btn btn-icon" id="notification-bell-btn" title="Notifications"
							style="position: relative;">
							🔔
							<span id="notification-bell-badge" class="hidden">0</span>
						</button>
						<button class="btn btn-icon" id="settings-btn" title="Library Settings">
							⚙️
						</button>
					</div>
				</div>
			</header>

			<!-- Telemetry Opt-out Banner -->
			<div id="telemetry-banner" class="hidden" style="
					margin: 12px 16px 0;
					padding: 12px 16px;
					border: 1px solid var(--border-color);
					border-radius: 8px;
					background: var(--bg-tertiary);
					color: var(--text-primary);
					display: flex;
					gap: 12px;
					align-items: center;
					justify-content: space-between;
					flex-wrap: wrap;
				">
				<div style="display: flex; gap: 10px; align-items: center;">
					<span style="font-size: 16px;">📊</span>
					<span style="font-size: 13px; line-height: 1.4;">
						We collect anonymous usage counts to improve Ranobe Gemini.
						You can opt out now or anytime in Settings.
					</span>
				</div>
				<div style="display: flex; gap: 8px; align-items: center;">
					<button id="telemetry-banner-disable" class="btn btn-secondary">
						Opt Out
					</button>
					<button id="telemetry-banner-keep" class="btn btn-primary">
						Keep Enabled
					</button>
				</div>
			</div>
			<!-- Continue Reading Hero -->
			<div id="hero-section" class="hero-section hidden">
				<div class="hero-card">
					<img id="hero-cover" class="hero-cover" src="" alt="" loading="lazy" />
					<div class="hero-info">
						<div id="hero-site-badge" class="hero-site-badge"></div>
						<h2 id="hero-title" class="hero-title"></h2>
						<p id="hero-author" class="hero-author"></p>
						<div id="hero-progress" class="hero-progress"></div>
						<div class="hero-actions">
							<a id="hero-continue-btn" href="#" class="btn btn-primary" target="_blank">
								▶ Continue Reading
							</a>
							<button id="hero-details-btn" class="btn btn-secondary">View Details</button>
						</div>
					</div>
				</div>
			</div>

			<!-- Recent Novels Carousel -->
			<div class="carousel-section" id="carousel-section">
				<div class="carousel-header">
					<h2 class="carousel-title">🔥 Recently Read</h2>
				</div>
				<div class="carousel-container">
					<div class="carousel-track" id="carousel-track">
						<!-- Carousel items will be populated by JavaScript -->
					</div>
				</div>
				<div class="carousel-footer">
					<button class="carousel-btn" id="carousel-prev" title="Previous">
						◀
					</button>
					<div class="carousel-indicators" id="carousel-indicators">
						<!-- Indicators will be populated by JavaScript -->
					</div>
					<button class="carousel-btn" id="carousel-play-pause" title="Pause auto-scroll">
						⏸️
					</button>
					<button class="carousel-btn" id="carousel-next" title="Next">
						▶
					</button>
				</div>
			</div>

			<!-- Stats Bar -->
			<div class="stats-bar">
				<div class="stat-item">
					<span class="stat-value" id="total-novels">0</span>
					<span class="stat-label">Novels</span>
				</div>
				<div class="stat-item">
					<span class="stat-value" id="total-chapters">0</span>
					<span class="stat-label">Enhanced Chapters</span>
				</div>
				<div class="stat-item">
					<span class="stat-value" id="shelf-count">0</span>
					<span class="stat-label">Active Websites</span>
				</div>
			</div>

			<!-- View Toggle -->
			<div class="view-controls">
				<div class="view-toggle">
					<button class="view-btn active" data-view="shelves" title="View by Shelves">
						📚 Shelves
					</button>
					<button class="view-btn" data-view="recent" title="Recent Novels">
						🕐 Recent
					</button>
					<button class="view-btn" data-view="all" title="All Novels">
						📋 All
					</button>
					<button class="view-btn" data-view="lists" title="Reading Lists">
						📖 Lists
					</button>
				</div>
				<div class="sort-controls">
					<label for="sort-select">Sort by:</label>
					<select id="sort-select">
						<option value="recent">Recently Read</option>
						<option value="added">Date Added</option>
						<option value="title">Title (A-Z)</option>
						<option value="chapters">Enhanced Chapters</option>
					</select>
				</div>
			</div>

			<!-- Reading Status Filter (shown in Lists view) — populated dynamically by library.js -->
			<div id="reading-status-filter" class="reading-status-filter hidden">
				<!-- JS renders status filter buttons here based on librarySettings -->
			</div>

			<!-- Main Content -->
			<main class="library-main">
				<!-- Shelves View -->
				<div id="shelves-view" class="view-content active">
					<!-- Shelves will be populated by JavaScript -->
				</div>

				<!-- Recent View -->
				<div id="recent-view" class="view-content">
					<h2 class="section-title">Recently Read</h2>
					<div id="recent-novels" class="novel-grid">
						<!-- Recent novels will be populated by JavaScript -->
					</div>
				</div>
				<!-- All Novels View -->
				<div id="all-view" class="view-content">
					<h2 class="section-title">All Novels</h2>
					<div id="all-novels" class="novel-grid">
						<!-- All novels will be populated by JavaScript -->
					</div>
				</div>

				<!-- Reading Lists View -->
				<div id="lists-view" class="view-content">
					<h2 class="section-title" id="lists-title">
						Reading Lists
					</h2>
					<div id="lists-stats" class="lists-stats">
						<!-- Reading status counts will be shown here -->
					</div>
					<div id="lists-novels" class="novel-grid">
						<!-- Filtered novels will be populated by JavaScript -->
					</div>
				</div>

				<!-- Empty State -->
				<div id="empty-state" class="empty-state hidden">
					<div class="empty-icon">📚</div>
					<h2>Your Library is Empty</h2>
					<p>
						Start reading novels on supported sites and they'll
						appear here automatically when you enhance chapters.
					</p>
					<div class="supported-sites">
						<h3>Supported Sites</h3>
						<ul id="supported-sites-list">
							<!-- Dynamically populated from SHELVES -->
						</ul>
					</div>
				</div>

				<!-- Loading State -->
				<div id="loading-state" class="loading-state">
					<div class="spinner"></div>
					<p>Loading your library...</p>
				</div>
			</main>

			<!-- Novel Detail Modal -->
			<div id="novel-modal" class="modal hidden">
				<div class="modal-backdrop"></div>
				<div class="modal-content">
					<button class="modal-close" id="modal-close">
						&times;
					</button>

					<div class="novel-detail">
						<div class="novel-detail-header">
							<div id="modal-cover-container" class="novel-cover-container">
								<img id="modal-cover" src="" alt="Cover" class="novel-cover-large" />
							</div>
							<div class="novel-info">
								<h2 id="modal-title"></h2>
								<p class="novel-author">
									by <span id="modal-author"></span>
								</p>
								<div class="novel-meta">
									<span class="meta-badge" id="modal-shelf"></span>
									<span class="meta-badge" id="modal-status"></span>
									<select id="modal-status-selector" class="status-selector"
										title="Change Reading Status">
										<!-- Options populated by JavaScript from getAllStatuses() -->
									</select>
									<!-- Re-reading overlay toggle — shown/hidden by JS based on settings -->
									<button id="modal-rereading-toggle" class="rereading-toggle hidden"
										title="Toggle re-reading flag">
										<!-- Label set by JS -->
									</button>
								</div>
								<div class="novel-stats">
									<div class="stat">
										<span class="stat-num" id="modal-chapters">0</span>
										<span class="stat-text">Chapters</span>
									</div>
									<div class="stat">
										<span class="stat-num" id="modal-enhanced">0</span>
										<span class="stat-text">Enhanced</span>
									</div>
									<div class="stat">
										<span class="stat-num" id="modal-last-read">0</span>
										<span class="stat-text">Last Read</span>
									</div>
								</div>
							</div>
						</div>

						<div class="novel-detail-body">
							<div class="novel-description">
								<h3>Description</h3>
								<p id="modal-description"></p>
							</div>

							<!-- Website-specific metadata section -->
							<div class="novel-metadata" id="modal-metadata-container" style="display: none">
								<!-- Rating/Warnings section for AO3/fanfic sites -->
								<div class="metadata-section" id="modal-rating-section" style="display: none">
									<h3>Rating & Warnings</h3>
									<div class="metadata-row">
										<span class="metadata-label">Rating:</span>
										<span id="modal-rating" class="rating-badge"></span>
									</div>
									<div class="metadata-row" id="modal-warnings-row" style="display: none">
										<span class="metadata-label">Warnings:</span>
										<div id="modal-warnings" class="tag-list warning-tags"></div>
									</div>
									<div class="metadata-row" id="modal-categories-row" style="display: none">
										<span class="metadata-label">Categories:</span>
										<div id="modal-categories" class="tag-list category-tags"></div>
									</div>
								</div>

								<!-- Fandoms section -->
								<div class="metadata-section" id="modal-fandoms-section" style="display: none">
									<h3>Fandoms</h3>
									<div id="modal-fandoms" class="tag-list fandom-tags"></div>
								</div>

								<!-- Relationships section -->
								<div class="metadata-section" id="modal-relationships-section" style="display: none">
									<h3>Relationships</h3>
									<div id="modal-relationships" class="tag-list relationship-tags"></div>
								</div>

								<!-- Characters section -->
								<div class="metadata-section" id="modal-characters-section" style="display: none">
									<h3>Characters</h3>
									<div id="modal-characters" class="tag-list character-tags"></div>
								</div>

								<!-- Additional Tags section -->
								<div class="metadata-section" id="modal-additional-tags-section" style="display: none">
									<h3>Additional Tags</h3>
									<div id="modal-additional-tags" class="tag-list additional-tags"></div>
								</div>

								<!-- Work Stats section -->
								<div class="metadata-section" id="modal-work-stats-section" style="display: none">
									<h3>Work Stats</h3>
									<div class="work-stats-grid" id="modal-work-stats"></div>
								</div>
							</div>

							<div class="novel-actions">
								<a id="modal-continue-btn" href="#" class="btn btn-primary" target="_blank">Continue
									Reading</a>
								<a id="modal-source-btn" href="#" target="_blank" class="btn btn-secondary"
									target="_blank">View on Site</a>
								<button id="modal-refresh-btn" class="btn btn-secondary"
									title="Reset manual edits and refresh metadata from source">
									🔄 Refresh Metadata
								</button>
								<button id="modal-edit-btn" class="btn btn-secondary">
									✏️ Edit Details
								</button>
								<button id="modal-copy-info-btn" class="btn btn-secondary"
									title="Copy novel info to clipboard">
									📋 Copy Info
								</button>
								<button id="modal-remove-btn" class="btn btn-danger">
									Remove from Library
								</button>
							</div>
						</div>
					</div>
				</div>
			</div>


			<!-- Telemetry Consent Modal (First Run) -->
			<div id="telemetry-consent-modal" class="modal hidden">
				<div class="modal-backdrop"></div>
				<div class="modal-content modal-small" style="max-width: 480px;">
					<h2>📊 Anonymous Usage Analytics</h2>
					<p style="margin: 16px 0; line-height: 1.6;">
						Ranobe Gemini collects anonymous usage statistics to help improve the extension.
						This is <strong>enabled by default</strong> but you can opt out anytime.
					</p>
					<div style="background: var(--bg-tertiary); padding: 16px; border-radius: 8px; margin: 16px 0;">
						<h4 style="margin: 0 0 12px 0; font-size: 14px;">What we collect:</h4>
						<ul style="margin: 0; padding-left: 20px; font-size: 13px; line-height: 1.6;">
							<li>Anonymous view counts (via CFlair-Counter)</li>
							<li>Feature usage counts (no content, just counts)</li>
							<li>Error reports (optional, helps fix bugs)</li>
						</ul>
						<h4 style="margin: 16px 0 12px 0; font-size: 14px;">What we NEVER collect:</h4>
						<ul style="margin: 0; padding-left: 20px; font-size: 13px; line-height: 1.6;">
							<li>API keys or credentials</li>
							<li>Novel reading history or library data</li>
							<li>Personal information of any kind</li>
						</ul>
					</div>
					<p style="margin: 16px 0; font-size: 13px; color: var(--text-secondary);">
						You can change this setting anytime in Library Settings → Analytics & Diagnostics.
					</p>
					<div style="display: flex; gap: 12px; justify-content: flex-end; margin-top: 24px;">
						<button id="telemetry-decline-btn" class="btn btn-secondary">
							Opt Out
						</button>
						<button id="telemetry-accept-btn" class="btn btn-primary">
							Keep Enabled
						</button>
					</div>
				</div>
			</div>

			<!-- Notification Panel -->
			<div id="notification-panel" class="notification-panel hidden">
				<div class="notification-panel-backdrop"></div>
				<div class="notification-panel-content">
					<div class="notification-panel-header">
						<h3>🔔 Notifications</h3>
						<button class="notification-panel-close" id="notification-panel-close">
							&times;
						</button>
					</div>
					<div class="notification-panel-body">
						<div class="notification-actions">
							<button id="library-mark-all-read" class="btn btn-secondary">
								✓ Mark All Read
							</button>
							<button id="library-clear-all-notifications" class="btn btn-secondary">
								🗑 Clear All
							</button>
						</div>
						<div id="library-notification-list" class="notification-list">
							<!-- Notifications will be populated by JavaScript -->
						</div>
					</div>
				</div>
			</div>

			<!-- Inline edit modal container (used by edit-modal.js) -->
			<div id="shelf-edit-modal"></div>

			<!-- Browser API polyfill for Chrome/Edge compatibility -->
			<script src="../lib/browser-polyfill.min.js"></script>

			<!-- Service Worker registration (PWA offline support) -->
			<script>
				if ('serviceWorker' in navigator) {
					navigator.serviceWorker.register('sw.js').catch(() => { });
				}
			</script>

			<script type="module" src="library.js"></script>
	</body>

</html>